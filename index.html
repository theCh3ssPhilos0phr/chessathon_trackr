<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CHESSATHON · QR Checkpoint Tracker</title>
<style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background: #f4f4f4; }
    h1 { color: #333; }
    button { padding: 10px 15px; margin: 5px; }
    .view { margin-top: 20px; }
</style>
</head>
<body>
<h1>CHESSATHON · QR Checkpoint Tracker</h1>
<p>Event prototype • offline-first • local-only (no server). Swap to Firebase later.</p>
<div id="tabs"></div>
<div id="app"></div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
let current = 'player';
let playerId = localStorage.getItem('playerId') || '';
let checkpoints = JSON.parse(localStorage.getItem('checkpoints') || '[]');
let checkins = JSON.parse(localStorage.getItem('checkins') || '[]');

function setView(v) { current = v; render(); }

function PlayerView() {
    const div = document.createElement('div');
    div.className = 'view';
    const input = document.createElement('input');
    input.placeholder = 'Enter your name';
    input.value = playerId;
    const btn = document.createElement('button');
    btn.textContent = 'Create My Player ID';
    btn.onclick = () => {
        playerId = input.value.trim();
        localStorage.setItem('playerId', playerId);
        alert('Player ID saved!');
    };
    div.append(input, btn);
    return div;
}

function OrganizerView() {
    const div = document.createElement('div');
    div.className = 'view';
    const input = document.createElement('input');
    input.placeholder = 'Checkpoint name';
    const btn = document.createElement('button');
    btn.textContent = 'Add Checkpoint';
    btn.onclick = () => {
        const name = input.value.trim();
        if (!name) return alert('Enter a name');
        const id = 'cp-' + Date.now();
        checkpoints.push({ id, name });
        localStorage.setItem('checkpoints', JSON.stringify(checkpoints));
        render();
    };
    div.append(input, btn);

    checkpoints.forEach(cp => {
        const p = document.createElement('p');
        p.textContent = cp.name;
        const canvas = document.createElement('canvas');
        QRCode.toCanvas(canvas, location.href.split('#')[0] + '#scan?cp=' + cp.id);
        div.append(p, canvas);
    });

    return div;
}

function ScanView() {
    const div = document.createElement('div');
    div.className = 'view';
    const params = new URLSearchParams(location.hash.split('?')[1]);
    const cpId = params.get('cp');
    const cp = checkpoints.find(c => c.id === cpId);
    if (!cp) { div.textContent = 'Invalid checkpoint.'; return div; }
    const btn = document.createElement('button');
    btn.textContent = 'Confirm Check-In at ' + cp.name;
    btn.onclick = () => {
        if (!playerId) return alert('Set your Player ID first!');
        checkins.push({ playerId, cpId, time: new Date().toLocaleString() });
        localStorage.setItem('checkins', JSON.stringify(checkins));
        alert('Check-in recorded!');
    };
    div.append(btn);
    return div;
}

function AdminView() {
    const div = document.createElement('div');
    div.className = 'view';
    checkins.forEach(c => {
        const cp = checkpoints.find(cp => cp.id === c.cpId);
        const p = document.createElement('p');
        p.textContent = c.time + ' - ' + c.playerId + ' @ ' + (cp ? cp.name : 'Unknown');
        div.append(p);
    });
    return div;
}

function render() {
    const tabsEl = document.getElementById('tabs');
    tabsEl.innerHTML = '';
    [['player','Player'], ['organizer','Organizer'], ['scan','Scan'], ['admin','Admin']].forEach(([id,label]) => {
        const b = document.createElement('button');
        b.textContent = label;
        if (id === current) b.style.fontWeight = 'bold';
        b.onclick = () => setView(id);
        tabsEl.append(b);
    });

    const root = document.getElementById('app');
    root.innerHTML = '';
    if (current === 'player') root.appendChild(PlayerView());
    if (current === 'organizer') root.appendChild(OrganizerView());
    if (current === 'scan') root.appendChild(ScanView());
    if (current === 'admin') root.appendChild(AdminView());
}

if (location.hash.startsWith('#scan')) current = 'scan';
render();
</script>
</body>
</html>
