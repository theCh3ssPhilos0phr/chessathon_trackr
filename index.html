<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chessathon Tracker</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
  header { background: #222; color: #fff; padding: 1em; text-align: center; }
  main { padding: 1em; }
  nav button { margin: 0.2em; padding: 0.5em 1em; }
  .hidden { display: none; }
  table { border-collapse: collapse; width: 100%; margin-top: 1em; }
  th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
  tr.flash { background-color: #c8f7c5 !important; transition: background-color 1s ease; }
</style>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>
<header>
  <h1>Chessathon Tracker</h1>
</header>
<main>
  <nav>
    <button onclick="showTab('organizer')">Organizer</button>
    <button onclick="showTab('scan')">Player Check-In</button>
    <button onclick="showTab('admin')">Admin</button>
  </nav>

  <!-- Organizer Tab -->
  <section id="organizer">
    <h2>Organizer: Add Checkpoint</h2>
    <input id="checkpointName" placeholder="Checkpoint name" />
    <button onclick="addCheckpoint()">Add</button>
    <div id="qrContainer"></div>
    <h3>Existing Checkpoints</h3>
    <ul id="checkpointList"></ul>
  </section>

  <!-- Player Tab -->
  <section id="scan" class="hidden">
    <h2>Player: Check-In</h2>
    <input id="playerId" placeholder="Your name or team" />
    <input id="checkpointCode" placeholder="Checkpoint code" />
    <button onclick="checkIn()">Confirm Check-In</button>
    <p id="scanStatus"></p>
  </section>

  <!-- Admin Tab -->
  <section id="admin" class="hidden">
    <h2>Admin: Live Check-Ins</h2>
    <table>
      <thead>
        <tr><th>Player</th><th>Checkpoint</th><th>Time</th></tr>
      </thead>
      <tbody id="checkinTable"></tbody>
    </table>
  </section>
</main>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDX8K85sA807SwMKwdJ3S6AyWH3LaUhw0c",
  authDomain: "chessathon-trkr.firebaseapp.com",
  projectId: "chessathon-trkr",
  storageBucket: "chessathon-trkr.firebasestorage.app",
  messagingSenderId: "332693668426",
  appId: "1:332693668426:web:6945b9b31967d8b7995cb3",
  measurementId: "G-57J6GKTCDF"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const EVENT_ID = "chessathon-2025";

function showTab(tab) {
  document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
  document.getElementById(tab).classList.remove('hidden');
}

// Organizer: Add checkpoint
async function addCheckpoint() {
  const name = document.getElementById("checkpointName").value.trim();
  if (!name) return alert("Enter a checkpoint name");
  const code = name.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now();
  await db.collection("events").doc(EVENT_ID).collection("checkpoints").doc(code).set({ name });
  const url = window.location.origin + window.location.pathname + "?checkpoint=" + code;
  document.getElementById("qrContainer").innerHTML = "";
  QRCode.toCanvas(document.createElement('canvas'), url, function (err, canvas) {
    if (!err) document.getElementById("qrContainer").appendChild(canvas);
  });
  document.getElementById("checkpointName").value = "";
}

// Load checkpoints list
db.collection("events").doc(EVENT_ID).collection("checkpoints")
  .onSnapshot(snapshot => {
    const list = document.getElementById("checkpointList");
    list.innerHTML = "";
    snapshot.forEach(doc => {
      const li = document.createElement("li");
      li.textContent = doc.data().name + " (" + doc.id + ")";
      list.appendChild(li);
    });
  });

// Player check-in
async function checkIn() {
  const playerId = document.getElementById("playerId").value.trim();
  const code = document.getElementById("checkpointCode").value.trim();
  if (!playerId || !code) return alert("Enter both player ID and checkpoint code");

  // Verify checkpoint exists
  const cpDoc = await db.collection("events").doc(EVENT_ID).collection("checkpoints").doc(code).get();
  if (!cpDoc.exists) {
    document.getElementById("scanStatus").textContent = "Invalid checkpoint.";
    return;
  }

  const time = new Date();
  await db.collection("events").doc(EVENT_ID).collection("checkins").add({
    playerId, checkpoint: cpDoc.data().name, time: time.toISOString()
  });

  document.getElementById("scanStatus").textContent = "Checked in at " + cpDoc.data().name;
  document.getElementById("checkpointCode").value = "";
}

// Auto-fill checkpoint from URL param
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.has("checkpoint")) {
  showTab("scan");
  document.getElementById("checkpointCode").value = urlParams.get("checkpoint");
}

// Admin: live check-in table
db.collection("events").doc(EVENT_ID).collection("checkins").orderBy("time")
  .onSnapshot(snapshot => {
    const table = document.getElementById("checkinTable");
    table.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      const tr = document.createElement("tr");
      const localTime = new Date(data.time).toLocaleString();
      tr.innerHTML = "<td>" + data.playerId + "</td><td>" + data.checkpoint + "</td><td>" + localTime + "</td>";
      tr.classList.add("flash");
      table.appendChild(tr);
      setTimeout(() => tr.classList.remove("flash"), 1000);
    });
  });
</script>
</body>
</html>
